{% extends 'labreqsys/base.html' %}
{% load static tailwind_tags %}

{% block content %}

<div class="text-xl font-semibold text-myblue-primary mb-2"> Laboratory Requests</div>

<!-- TOP BAR -->
<div class="container text-center">
    <div class="flex flex-wrap justify-between items-center gap-4">
    <!-- SEARCH -->
        <div class="flex-1 max-w-sm min-w-[200px]">
            <div class="relative w-full">
                <input
                id="searchInput"
                class="block w-full z-20 text-xs text-gray-700 bg-gray-50 rounded border border-gray-200 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Search Request ID, Last Name, or Given Name" />
                
                <button type="submit" style="cursor: default;" class="absolute top-0 end-0 p-2.5 text-sm font-medium h-full text-white bg-myblue-primary rounded-e-lg">
                    <svg class="w-3 h-3 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                    </svg>
                    <span class="sr-only">Search</span>
                </button>
            </div>
        </div>


        <!-- Sort By Container -->
        <div class="justify-end relative">   
            <form action="" method="get" class="relative">             
                <div class="flex items-center gap-2">
                    <!-- Label -->
                    <label class="text-sm font-medium text-gray-500">Sort by</label>
        
                    <!-- Dropdown with custom white icon -->
                    <div class="relative">
                        <select name="sortby" onchange="this.form.submit()" 
                            class="appearance-none text-white bg-myblue-primary hover:bg-blue-800 font-medium rounded-lg text-sm px-7 py-2 pr-10">
                            <option value="latest" {% if request.GET.sortby == 'latest' %}selected{% endif %}>Latest First</option>
                            <option value="oldest" {% if request.GET.sortby == 'oldest' %}selected{% endif %}>Oldest First</option>
                        </select>
        
                        <!-- Custom white dropdown icon -->
                        <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
            </form>   
        </div>
    </div>
</div>

<div class="bg-white rounded-lg mt-4 shadow-lg pt-1">
{% for date, requests in ordered_lab_requests.items %}
    {% if date == today %}
        <div class="dateheader font-normal text-xs text-gray-500 px-4 mt-3">Today</div>
        <div class="dateheader font-semibold text-sm text-gray-500 px-4">{{ date|date:"M d" }}</div>
    {% elif date == yesterday %}
        <div class="dateheader font-normal text-xs text-gray-500 mt-3 px-4">Yesterday</div>
        <div class="dateheader font-semibold text-sm text-gray-500 px-4">{{ date|date:"M d" }}</div>
    {% else %}
        <div class="dateheader font-semibold text-sm text-gray-500 mt-3 px-4">{{ date|date:"M d" }}</div>
    {% endif %}
    <div class="labRequestsTable bg-white pb-2 mt-3">
        <div class="relative overflow-x-auto"> <!--TO FRONTEND: the table columns vary in size per table bc i think some patient names being longer affect the length of patient name column-->
            <table class="w-full bg-white text-left rtl:text-right justify-start text-gray-500 items-start">
                <thead class="uppercase bg-gray-50 text-gray-450 text-xs border-b">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-center">Request ID</th>
                        <th scope="col" class="px-6 py-3 w-64">Patient Name</th>
                        <th scope="col" class="px-6 py-3 text-center">Overall Status</th>
                        <th scope="col" class="px-6 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                {% for l in requests %}
                    <tr class="border-b border-gray-200 hover:bg-gray-200">
                        <th scope="row" class="px-6 py-3 text-sm text-center w-32">
                            {{ l.request_id }}
                        </th>
                        <td class="px-6 py-2 text-sm">{{ l.patient.last_name }}, {{ l.patient.first_name }}{% if l.patient.suffix %} {{ l.patient.suffix }}{% endif %}{% if l.patient.middle_initial %}, {{ l.patient.middle_initial }}.{% endif %}
                        </td>
                        <td class="px-6 py-2 text-center">
                            {% if l.overall_status == 'Not Started' %}
                                <span class="inline-flex items-center px-8 py-2 rounded-full text-xs font-medium bg-unstarted-secondary text-unstarted-primary shadow-sm border-unstarted-borderPrimary border">
                            {% elif l.overall_status == 'Completed' %}
                                <span class="inline-flex items-center px-8 py-2 rounded-full text-xs font-medium bg-complete-secondary text-complete-primary shadow-sm border border-complete-borderPrimary">
                            <!--TO FRONTEND: Released overall status pill needs to be modified-->
                            {% elif l.overall_status == 'Released' %}
                                <span class="inline-flex items-center px-8 py-2 rounded-full text-xs font-medium bg-complete-secondary text-complete-primary border border-complete-borderPrimary shadow-sm">
                            {% else %}
                                <span class="inline-flex items-center px-8 py-2 rounded-full text-xs font-medium bg-progress-secondary border border-progress-borderPrimary text-progress-primary text-progress shadow-sm">
                            {% endif %}
                                {{ l.overall_status }}
                        </td>
                        <td class="px-6 py-2 text-view text-center">
                            <a href="{% url 'view_individual_lab_request' request_id=l.request_id %}" class="no-underline text-sm text-myblue-highlight">
                                View Request
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;

        const sections = document.querySelectorAll('.labRequestsTable'); // each table

        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();

            sections.forEach(section => {
                const rows = section.querySelectorAll('tbody tr');
                const header = section.querySelector('thead');
                let anyRowVisible = false;

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    const requestID = cells[0]?.textContent.toLowerCase() || '';
                    const fullName = cells[1]?.textContent.toLowerCase() || '';

                    if (
                        requestID.includes(query) ||
                        fullName.includes(query)
                    ) {
                        row.style.display = '';
                        anyRowVisible = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                if (header) {
                    header.style.display = anyRowVisible ? '' : 'none';
                }

                const previousDateLabels = [];
                let sibling = section.previousElementSibling;

                while (sibling && sibling.classList.contains('dateheader')) {
                    previousDateLabels.push(sibling);
                    sibling = sibling.previousElementSibling;
                }

                section.style.display = anyRowVisible ? '' : 'none';
                previousDateLabels.forEach(label => {
                    label.style.display = anyRowVisible ? '' : 'none';
                });
            });
        });
    });
</script>



{% endblock content %}

{% block styles %}
<!--insert styles here-->
{% endblock styles %}