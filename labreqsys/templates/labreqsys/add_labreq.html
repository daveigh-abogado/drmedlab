{% extends 'labreqsys/base.html' %}
{% load static tailwind_tags %}

{% block content %}

<div class="tabs">
    <button onclick="showTab(0)">Package</button>
    <button onclick="showTab(1)">Component</button>
</div>
<div class="container">
    <form id="form" method="POST" action="{% url 'summarize_labreq' pk=patient.pk %}">{% csrf_token %}
        <div class="half">
            <div class="tab active" id="tab-0">
                <h1>Select a Package</h1>
                <hr>
                {% for pa in test_packages %}
                    <input type="checkbox" name="packages" value="{{ pa.pk }}" 
                        data-name="{{ pa.package_name }}" 
                        data-price="{{ pa.package_price }}" 
                        data-components='{{ pa.components|safe }}' 
                        class="package-checkbox"> {{ pa.package_name }}
                {% endfor %}
            </div>
            <div class="tab" id="tab-1">
                <h1>Select a Component</h1>
                <hr>
                {% for c in test_comps %}
                    <input type="checkbox" name="components" value="{{ c.pk }}" 
                        data-name="{{ c.test_name }}" 
                        data-price="{{ c.component_price }}" 
                        class="component-checkbox"> {{ c.test_name }}
                {% endfor %}
            </div>
            <button type="button" onclick="addOptions()">Add Options</button>
        </div>
        <div class="half">
            <h1>Selected Options</h1>
            <hr>
            <ul id="selectedList" class="selected-options"></ul>
            <hr>
            <h2>Subtotal ₱<span id="totalPrice">0.00</span></h2>
            <button type="submit">Next</button>
        </div>
    </form>
</div>

<script>
    let counter = 1;
    const packageData = JSON.parse('{{ package_data|escapejs }}');

    function showTab(index) {
        document.querySelectorAll('.tab').forEach((tab, i) => {
            tab.classList.toggle('active', i === index);
        });
    }

    function addOptions() {
        const selectedList = document.getElementById('selectedList');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');

        checkboxes.forEach(checkbox => {
            const name = checkbox.getAttribute('data-name');
            const price = parseFloat(checkbox.getAttribute('data-price')) || 0;
            const id = checkbox.value;
            const isPackage = checkbox.classList.contains('package-checkbox');

            if (!document.querySelector(`#selectedList li[data-id="${id}"]`)) {
                addSelectedOption(name, price, id, isPackage);

                if (isPackage && packageData[id]) {
                    packageData[id].forEach(componentName => {
                        if (!document.querySelector(`#selectedList li[data-name="${componentName}"]`)) {
                            addSelectedComponent(componentName, id);
                            disableComponentCheckbox(componentName, true);
                        }
                    });
                }

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = isPackage ? 'selected_packages' : 'selected_components';
                hiddenInput.value = id;
                hiddenInput.setAttribute('data-id', id);
                document.getElementById('form').appendChild(hiddenInput);

                checkbox.checked = false;
                checkbox.disabled = true;
            }
        });

        renumberOptions();
        recalculateTotal();
    }

    function addSelectedOption(name, price, id, isPackage) {
        const selectedList = document.getElementById('selectedList');
        const li = document.createElement('li');
        li.setAttribute('data-id', id);
        li.setAttribute('data-price', price);
        li.innerHTML = `<span class="option-number"></span> ${name} - ₱${price.toFixed(2)} 
            <img src="{% static 'images/delete.png' %}" class="trash-icon" onclick="removeOption(this, '${id}')">`;
        selectedList.appendChild(li);
    }

    function addSelectedComponent(name, packageId) {
        const selectedList = document.getElementById('selectedList');
        const li = document.createElement('li');
        li.setAttribute('data-name', name);
        li.setAttribute('data-package-id', packageId);
        li.classList.add('package-component'); 
        li.textContent = `- ${name}`;
        selectedList.appendChild(li);
    }

    function removeOption(trashIcon, id) {
        const li = trashIcon.parentElement;
        const name = li.getAttribute('data-name');
        li.remove();

        document.querySelector(`input[data-id="${id}"]`)?.remove();
        
        const checkbox = document.querySelector(`input[value="${id}"]`);
        if (checkbox) {
            checkbox.disabled = false;
            checkbox.checked = false;
        }

        if (packageData[id]) {
            packageData[id].forEach(componentName => {
                const compLi = document.querySelector(`#selectedList li[data-name="${componentName}"]`);
                if (compLi) {
                    compLi.remove();
                    disableComponentCheckbox(componentName, false);
                }
            });
        }

        renumberOptions();
        recalculateTotal();
    }

    function disableComponentCheckbox(name, disable) {
        document.querySelectorAll(`input[data-name="${name}"]`).forEach(checkbox => {
            checkbox.disabled = disable;
        });
    }

    function renumberOptions() {
        let num = 1;
        document.querySelectorAll('#selectedList li .option-number').forEach(span => {
            span.textContent = `${num}. `;
            num++;
        });
    }

    function recalculateTotal() {
        let newTotal = 0;
        document.querySelectorAll('#selectedList li:not(.package-component)').forEach(li => {
            newTotal += parseFloat(li.getAttribute('data-price')) || 0;
        });
        document.getElementById('totalPrice').textContent = newTotal.toFixed(2);
    }
</script>

{% endblock content %}

{% block styles %}
<style>
    .tab {
        display: none;
    }
    .tab.active {
        display: block;
    }
    .tabs {
        display: flex;
        gap: 10px;
    }
    .tabs button {
        padding: 10px;
        cursor: pointer;
    }
    .trash-icon {
        width: 20px;
        cursor: pointer;
    }
    .container {
        display: flex;
        flex-direction: row;
    }
</style>
{% endblock styles %}
