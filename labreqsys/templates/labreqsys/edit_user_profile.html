{% extends 'labreqsys/base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block content %}
<div class="relative p-4 w-full max-w-3xl h-full md:h-auto mx-auto mt-10">
    <div class="relative p-4 bg-white rounded-lg shadow sm:p-5 max-w-lg mx-auto">
        <div class="flex justify-between items-center pb-2 rounded-t border-b sm:mb-5">
            <h3 class="text-lg font-semibold text-blue-900">
                Edit User Profile 
            </h3>
        </div>
        <div class="mb-4 text-xs text-gray-500">Required fields are marked with <span class="text-red-600">*</span></div>
        <div id="banner-messages">
        {% if messages %}
            <ul class="mb-4 flex flex-col items-center">
                {% for message in messages %}
                    <li class="w-full flex items-center justify-center px-4 py-2 rounded mb-2 fade-in text-xs
                        {% if message.tags == 'success' %}bg-complete-secondary border-complete-borderPrimary text-complete-primary {% elif message.tags == 'error' %}bg-red-100 border border-red-400 text-red-800{% else %}bg-gray-100 border border-gray-300 text-gray-800{% endif %}">
                        {% if message.tags == 'success' %}
                            <svg class="w-5 h-5  text-complete-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                        {% elif message.tags == 'error' %}
                            <svg class="w-5 h-5  text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                        {% endif %}
                        <span class="flex-1 text-center">{{ message }}</span>
                        <button type="button" onclick="this.parentElement.style.display='none'" class="ml-4 text-lg font-bold focus:outline-none text-complete-primary on-click">&times;</button>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
        </div>
        <!-- Profile Update Form -->
        <form method="post" enctype="multipart/form-data" class="gap-2.5" autocomplete="off">
            {% csrf_token %}
            {% if role == 'lab_tech' %}
                {% if labtech_missing_warning %}
                    <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">{{ labtech_missing_warning }}</div>
                {% endif %}
                {% if labtech_form and labtech_form.instance %}
                    <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h4 class="text-base font-bold text-blue-800 mb-2 tracking-wide uppercase">Current Lab Tech Information</h4>
                        <div class="grid gap-2.5 mb-2 sm:grid-cols-2">
                            <div>
                                <span class="block text-xs text-gray-500">Title</span>
                                <span class="font-medium text-gray-900">{{ labtech_form.instance.title|default:'-' }}</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500">Tech Role</span>
                                <span class="font-medium text-gray-900">{{ labtech_form.instance.tech_role|default:'-' }}</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="block text-xs text-gray-500">License Number</span>
                            <span class="font-medium text-gray-900">{{ labtech_form.instance.license_num|default:'-' }}</span>
                        </div>
                        <div class="mb-2">
                            <span class="block text-xs text-gray-500">Current Signature</span><br>
                            {% if labtech_form.instance.signature_path %}
                                <img src="{% static labtech_form.instance.signature_path %}" alt="Current Signature" class="h-16 mb-2 border rounded">
                                <span class="block text-xs text-gray-500 mt-1">Your signature is permanent and cannot be changed. Please contact admin you think this is an error.</span>
                            {% else %}
                                <span class="text-gray-400">No signature uploaded</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                {% if profile_form %}
                    <h4 class="text-sm font-semibold text-blue-800 mb-2 mt-2 tracking-wide uppercase">User Information</h4>
                    {% for field in profile_form %}
                <div class="mb-4">
                            <label class="block mb-2 text-left text-sm font-medium text-gray-500">
                                {{ field.label }}{% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
                            </label>
                            {{ field|add_class:'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5' }}
                            {% if field.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</p>
                            {% endif %}
                </div>
                    {% endfor %}
                {% endif %}
                {% if labtech_form %}
                    <h4 class="text-sm font-semibold text-blue-800 mb-2 mt-6 tracking-wide uppercase">Lab Tech Information</h4>
                    {% for field in labtech_form %}
                        {% if field.name != 'signature_path' %}
                            <div class="mb-4">
                                <label class="block mb-2 text-left text-sm font-medium text-gray-500">
                                    {{ field.label }}{% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
                                </label>
                                {{ field|add_class:'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5' }}
                                {% if field.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% else %}
                {% if profile_form %}
                    {% for field in profile_form %}
                        <div class="mb-4">
                            <label class="block mb-2 text-left text-sm font-medium text-gray-500">
                                {{ field.label }}{% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
                            </label>
                            {{ field|add_class:'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5' }}
                            {% if field.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</p>
                            {% endif %}
                    </div>
                    {% endfor %}
                {% endif %}
            {% endif %}
            <button type="submit" name="profile_submit" class="w-full justify-center text-white inline-flex items-center bg-myblue-primary font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-2">
                Save Profile Information
                </button>
            </form>
        <!-- Password Change Form -->
        <form method="post" class="gap-2.5 mt-8" autocomplete="off">
            {% csrf_token %}
            <div class="mb-4 pt-2 border-t border-gray-200">
                <h5 class="text-base font-bold text-blue-800 mb-2 mt-2 tracking-wide uppercase">Change Password</h5>
                <p class="text-xs text-gray-600 mb-2">Change your account password. This does not affect your profile or signature.</p>
                {% for field in password_form %}
                    <div class="mb-2">
                        <label class="block mb-1 text-sm font-medium text-gray-500">
                            {{ field.label }}{% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
                        </label>
                        {{ field|add_class:'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5' }}
                        {% if field.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
                    </div>
            <button type="submit" name="password_submit" class="w-full justify-center text-white inline-flex items-center bg-myblue-primary font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-2">
                Change Password
                </button>
            </form>
    </div>
</div>
<style>
.fade-in { opacity: 0; animation: fadeIn 0.7s forwards; }
@keyframes fadeIn { to { opacity: 1; } }
</style>
<script>
window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var banners = document.querySelectorAll('#banner-messages li');
        banners.forEach(function(banner) {
            banner.style.opacity = 0;
            setTimeout(function() { banner.style.display = 'none'; }, 500);
        });
    }, 3000);
});
</script>
{% endblock %} 