{% extends 'labreqsys/base.html' %}
{% load static tailwind_tags %}
{% load static %}

{% block content %}
<div class="w-full h-hug p-8 pt-6 bg-white rounded-m shadow inline-flex flex-col justify-start items-start gap-8 overflow-hidden">
    <!-- OWNERS SECTION -->
    <div class="self-stretch inline-flex flex-col justify-start items-start gap-2.5">
        <div class="self-stretch py-2.5 px-2.5 border-b border-black/20 inline-flex justify-center items-center gap-1.5">
            <div class="flex-1 h-9 justify-center text-blue-900 text-mm font-semibold">Owners</div>
        </div>
        <div class="self-stretch">
            <table class="w-full bg-white rounded-xl text-left text-gray-500 items-start relative overflow-x-auto">
                <thead class="flex-1 justify-center items-start overflow-hidden uppercase">
                    <tr class="self-stretch h-[42px] bg-gray-50 text-gray-450 border-b gap-2.5 justify-start text-xs">
                        <th class="px-6 py-3">Username</th>
                        <th class="px-6 py-3">Name</th>
                        <th class="px-6 py-3">Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in owners %}
                    <tr class="border-b border-gray-200 hover:bg-gray-200">
                        <td class="px-6 py-3">{{ entry.user.username }}</td>
                        <td class="px-6 py-3">{{ entry.user.last_name }}, {{ entry.user.first_name }}</td>
                        <td class="px-6 py-3">{{ entry.user.email }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="px-6 py-3 text-center text-sm text-gray-500">No owners found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- RECEPTIONISTS SECTION -->
    <div class="self-stretch inline-flex flex-col justify-start items-start gap-2.5">
        <div class="self-stretch py-2.5 px-2.5 border-b border-black/20 inline-flex justify-center items-center gap-1.5">
            <div class="flex-1 h-9 justify-center text-blue-900 text-mm font-semibold">Receptionists</div>
        </div>
        <div class="self-stretch">
            <table class="w-full bg-white rounded-xl text-left text-gray-500 items-start relative overflow-x-auto">
                <thead class="flex-1 justify-center items-start overflow-hidden uppercase">
                    <tr class="self-stretch h-[42px] bg-gray-50 text-gray-450 border-b gap-2.5 justify-start text-xs">
                        <th class="px-6 py-3">Username</th>
                        <th class="px-6 py-3">Name</th>
                        <th class="px-6 py-3">Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in receptionists %}
                    <tr class="border-b border-gray-200 hover:bg-gray-200">
                        <td class="px-6 py-3">{{ entry.user.username }}</td>
                        <td class="px-6 py-3">{{ entry.user.last_name }}, {{ entry.user.first_name }}</td>
                        <td class="px-6 py-3">{{ entry.user.email }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="px-6 py-3 text-center text-sm text-gray-500">No receptionists found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- LAB TECHNICIANS SECTION -->
    <div class="self-stretch inline-flex flex-col justify-start items-start gap-2.5">
        <div class="self-stretch py-2.5 px-2.5 border-b border-black/20 inline-flex justify-center items-center gap-1.5">
            <div class="flex-1 h-9 justify-center text-blue-900 text-mm font-semibold">Lab Technicians</div>
        </div>
        <div class="self-stretch">
            <table class="w-full bg-white rounded-xl text-left text-gray-500 items-start relative overflow-x-auto">
                <thead class="flex-1 justify-center items-start overflow-hidden uppercase">
                    <tr class="self-stretch h-[42px] bg-gray-50 text-gray-450 border-b gap-2.5 justify-start text-xs">
                        <th class="px-6 py-3">Name</th>
                        <th class="px-6 py-3">Title</th>
                        <th class="px-6 py-3 text-center">Role</th>
                        <th class="px-6 py-3 text-center">License</th>
                        <th class="px-6 py-3 text-center">Signature</th>
                        <th class="px-6 py-3 text-center">User Account</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in labtechs %}
                    <tr class="border-b border-gray-200 hover:bg-gray-200">
                        <td class="px-6 py-3">
                            {% if entry.labtech %}
                                {{ entry.labtech.last_name }}, {{ entry.labtech.first_name }}
                            {% elif entry.user %}
                                {{ entry.user.last_name }}, {{ entry.user.first_name }}
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                        <td class="px-6 py-3">
                            {% if entry.labtech %}
                                {{ entry.labtech.title }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-center">
                            {% if entry.labtech %}
                                {{ entry.labtech.tech_role }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-center">
                            {% if entry.labtech %}
                                {{ entry.labtech.license_num }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-center">
                            {% if entry.labtech and entry.labtech.signature_path %}
                                <img src="{% static entry.labtech.signature_path %}" alt="Signature" class="h-8">
                            {% elif entry.labtech %}
                                <span>No signature</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-center">
                            {% if entry.has_user_account %}
                                <span class="text-green-600 font-semibold">User Account</span>
                            {% elif entry.labtech %}
                                <span class="text-red-600 font-semibold">No user account</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="px-6 py-3 text-center text-sm text-gray-500">No lab technicians found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Initialize modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        const modalBackdrop = document.getElementById('modalBackdrop');
        const addModal = document.getElementById('labTechModal');
        const editModal = document.getElementById('editLabTechModal');
        const addButton = document.getElementById('addLabTechButton');
        const addCloseButton = addModal.querySelector('[data-modal-toggle="labTechModal"]');
        const editCloseButton = document.getElementById('editModalCloseBtn');

        function closeModal(modal) {
            modal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
            modal.style.display = 'none';
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // Add modal event listeners
        addCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModal(addModal);
        });

        addButton.addEventListener('click', function() {
            openModal(addModal);
        });

        // Edit modal event listeners
        editCloseButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModal(editModal);
        });

        // Close modals when clicking backdrop
        modalBackdrop.addEventListener('click', function(e) {
            if (e.target === modalBackdrop) {
                if (!addModal.classList.contains('hidden')) {
                    closeModal(addModal);
                }
                if (!editModal.classList.contains('hidden')) {
                    closeModal(editModal);
                }
            }
        });

        // Close modals when pressing Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!addModal.classList.contains('hidden')) {
                    closeModal(addModal);
                }
                if (!editModal.classList.contains('hidden')) {
                    closeModal(editModal);
                }
            }
        });
    });

    function openEditModal(id, firstName, lastName, title, role, licenseNum, signaturePath) {
        const editModal = document.getElementById('editLabTechModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const form = document.getElementById('editLabTechForm');

        // Set form action
        form.action = `/edit_lab_tech/${id}/`;

        // Set form values
        document.getElementById('edit_first_name').value = firstName;
        document.getElementById('edit_last_name').value = lastName;
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_tech_role').value = role;
        document.getElementById('edit_license_num').value = licenseNum;
        
        // Set current signature image
        const currentSignature = document.getElementById('current_signature');
        if (signaturePath) {
            currentSignature.src = signaturePath;
            currentSignature.alt = "Current Signature";
            currentSignature.style.display = 'block';
        } else {
            currentSignature.style.display = 'none';
        }

        // Show modal
        editModal.classList.remove('hidden');
        modalBackdrop.classList.remove('hidden');
        editModal.style.display = 'flex';
    }
</script>

{% endblock %} 